#!/bin/sh
# Docker entrypoint
# Sets and enables heart (recommended only in daemon mode)
# if [ "$RELEASE_COMMAND" = "daemon" ] || [ "$RELEASE_COMMAND" = "daemon_iex" ]; then
#   HEART_COMMAND="$RELEASE_ROOT/bin/$RELEASE_NAME $RELEASE_COMMAND"
#   export HEART_COMMAND
#   export ELIXIR_ERL_OPTIONS="-heart"
# fi

# Set the release to work across nodes.
# RELEASE_DISTRIBUTION must be "sname" (local), "name" (distributed) or "none".
export RELEASE_DISTRIBUTION=name
export RELEASE_NODE=<%= @release.name %>@127.0.0.1

ELIXIR_ERL_OPTIONS="-kernel inet_dist_listen_min 9100 inet_dist_listen_max 9155"
export ELIXIR_ERL_OPTIONS

RELEASE_ROOT=$PHX_SERVER_ROOT
RELEASE_NAME="${RELEASE_NAME:-"cursor_demo"}"
RELEASE_VSN="${RELEASE_VSN:-"$(cut -d' ' -f2 "$RELEASE_ROOT/releases/start_erl.data")"}"
RELEASE_COMMAND="${1:-"daemon"}"

RELEASE_PROG="$RELEASE_ROOT/bin/$RELEASE_NAME"
RELEASE_COOKIE="${RELEASE_COOKIE:-"$(cat "$RELEASE_ROOT/releases/COOKIE")"}"
export RELEASE_COOKIE

RELEASE_TMP="${RELEASE_TMP:-"$RELEASE_ROOT/tmp"}"
export RELEASE_TMP
export RELEASE_MODE=embedded

RELEASE_DISTRIBUTION="${RELEASE_DISTRIBUTION:-"sname"}"
RELEASE_NODE="${RELEASE_NODE:-"$RELEASE_NAME"}"
export RELEASE_DISTRIBUTION
export RELEASE_NODE

# Start the release
exec "$RELEASE_PROG" "$RELEASE_COMMAND" 